package net.nooj4nlp.controller.TextCorpusDialog;

import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.File;
import java.util.ArrayList;
import java.util.List;

import javax.swing.JComboBox;

import net.nooj4nlp.controller.TextEditorShell.TextEditorShellController;
import net.nooj4nlp.engine.Ntext;
import net.nooj4nlp.engine.Paths;
import net.nooj4nlp.gui.dialogs.TextCorpusDialog;
import net.nooj4nlp.gui.main.Launcher;
import net.nooj4nlp.gui.shells.TextEditorShell;

public class TextNewActionListener implements ActionListener
{

	private TextCorpusDialog dialog;

	public boolean isNewText = false;

	public TextNewActionListener(TextCorpusDialog dialog)
	{
		this.dialog = dialog;
	}

	@SuppressWarnings("unchecked")
	public void actionPerformed(ActionEvent evt)
	{
		//input and chosen details needs to be saved
		if (this.dialog.rdbtnPerlRegExpr.isSelected())
		{
			JComboBox comboPerl = this.dialog.comboPerl;
			int selectedIndex = comboPerl.getSelectedIndex();
			List<String> perlList = Launcher.getRegexMemoryList();

			//if it's the case of an input text...
			if (selectedIndex == -1)
			{
				//...select the last one and add it to the list
				selectedIndex = comboPerl.getItemCount();
				perlList.add(comboPerl.getSelectedItem().toString());
				Launcher.setRegexMemoryList(perlList);
			}

			//remember radio button and combo index that was last chosen
			Launcher.setCorpusTextRadioButtonSelectionMemory(3);
			Launcher.setRegexMemoryIndex(selectedIndex);
		}
		else if (this.dialog.rdbtnXmlTextNodes.isSelected())
		{
			JComboBox comboXml = this.dialog.comboXml;
			int selectedIndex = comboXml.getSelectedIndex();
			List<String> xmlList = Launcher.getXmlMemoryList();

			//if it's the case of an input text...
			if (selectedIndex == -1)
			{
				//...select the last one and add it to the list
				selectedIndex = comboXml.getItemCount();
				xmlList.add(comboXml.getSelectedItem().toString());
				Launcher.setXmlMemoryList(xmlList);
			}

			//remember radio button and combo index that was last chosen
			Launcher.setCorpusTextRadioButtonSelectionMemory(4);
			Launcher.setXmlMemoryIndex(selectedIndex);
		}
		else if (this.dialog.rdbtnNoDelimiterwhole.isSelected())
			Launcher.setCorpusTextRadioButtonSelectionMemory(1);
		else
			Launcher.setCorpusTextRadioButtonSelectionMemory(2);

		// set the language name
		String languageName = (String) TextCorpusDialog.listLanguages.getSelectedValue();
		String dir = Paths.docDir + "\\" + languageName;
		File file = new File(dir);
		if (!file.isDirectory())
			file.mkdir();
		String dir2 = dir + "\\Lexical Analysis";
		File file2 = new File(dir2);
		if (!file.isDirectory())
			file.mkdir();
		dir2 = dir + "\\Syntactic Analysis";
		file2 = new File(dir2);
		if (!file.isDirectory())
			file.mkdir();

		// set the encoding for the file
		int encodingType = 1; // NooJ raw text
		String encodingCode = null;
		String encodingName = "Default";

		String delimPattern = "";
		String[] xmlNodes = null;

		if (TextCorpusDialog.rdbtnLineDelimiter.isSelected())
		{
			delimPattern = "\n";
			xmlNodes = null;
		}
		else if (TextCorpusDialog.rdbtnPerlRegExpr.isSelected())
		{
			delimPattern = (String) TextCorpusDialog.comboPerl.getSelectedItem();
		}
		else if (TextCorpusDialog.rdbtnXmlTextNodes.isSelected())
		{
			encodingType = -encodingType;
			// get all text zones
			@SuppressWarnings("rawtypes")
			ArrayList tmp = new ArrayList();
			for (int i = 0; i < ((String) TextCorpusDialog.comboXml.getSelectedItem()).length(); i++)
			{
				if (((String) TextCorpusDialog.comboXml.getSelectedItem()).charAt(i) == '<')
				{
					int j = 0;
					for (j = 0; i + j < ((String) TextCorpusDialog.comboXml.getSelectedItem()).length()
							&& ((String) TextCorpusDialog.comboXml.getSelectedItem()).charAt(j) != '>'; j++)
						;
					tmp.add(((String) TextCorpusDialog.comboXml.getSelectedItem()).substring(i, j + 1));
					i += j;
				}
			}
			if (tmp.size() == 0)
				xmlNodes = null;
			else
			{
				xmlNodes = new String[tmp.size()];
				for (int j = 0; j < xmlNodes.length; j++)
				{
					xmlNodes[j] = (String) tmp.get(j);
				}
			}
		}
		Ntext myText = new Ntext(languageName, delimPattern, xmlNodes);
		// open the text editor window
		TextEditorShell editor = new TextEditorShell(null, myText, "New text", delimPattern, true);
		Launcher.getDesktopPane().add(editor);
		editor.setVisible(true);

		if (editor != null)
		{
			TextEditorShellController textController = editor.getTextController();

			// Since this is only called when creating new text, at that time fileToBeOpenedOrImported is null!
			textController.setFileToBeOpenedOrImported(null);

			textController.rtbTextUpdate();
			textController.updateTextPaneStats();
			textController.modify();
		}

		dialog.dispose();
	}

}
